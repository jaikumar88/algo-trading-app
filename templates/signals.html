{% extends 'base.html' %}

{% block title %}Signals - Trading App{% endblock %}

{% block page_title %}Signals{% endblock %}

{% block content %}
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
            <div class="filters">
              <input id="filter-date" type="date" class="form-control form-control-sm" />
              <input id="filter-symbol" placeholder="Symbol (e.g. ETHUSD)" class="form-control form-control-sm" />
            </div>
            <div>
              <button id="btn-filter" class="btn btn-primary btn-sm">Filter</button>
            </div>
          </div>

          <div id="signals-summary" class="small muted mb-2"></div>
          <div class="table-responsive">
            <table id="signals-table" class="table table-striped table-sm">
              <thead><tr><th>ID</th><th>Symbol</th><th>Action</th><th>Price</th><th>Status</th><th>Time</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
async function loadSignals(date, symbol){
  try {
    const params = new URLSearchParams();
    if(date) params.set('date', date);
    if(symbol) params.set('symbol', symbol);
    params.set('limit', '100'); // Get more signals
    
    const r = await fetch('/api/trading/signals?'+params.toString());
    const j = await r.json();
    
    const tbody = document.querySelector('#signals-table tbody');
    tbody.innerHTML = '';
    
    if (j.signals && j.signals.length > 0) {
      j.signals.forEach(s => {
        const tr = document.createElement('tr');
        const createdAt = new Date(s.created_at).toLocaleDateString();
        const status = s.status || 'PENDING';
        const statusBadge = getStatusBadge(status);
        
        tr.innerHTML = `
          <td>${s.id}</td>
          <td>${s.symbol || 'N/A'}</td>
          <td><span class="badge ${s.action === 'BUY' ? 'bg-success' : 'bg-danger'}">${s.action || 'N/A'}</span></td>
          <td>$${s.price || 'N/A'}</td>
          <td>${statusBadge}</td>
          <td>${createdAt}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="viewSignal(${s.id})">View</button>
            ${status === 'PENDING' ? `
              <button class="btn btn-sm btn-success" onclick="validateSignal(${s.id}, true)">✓</button>
              <button class="btn btn-sm btn-danger" onclick="validateSignal(${s.id}, false)">✗</button>
            ` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.getElementById('signals-summary').textContent = 
        `Found ${j.total || j.signals.length} signals (showing ${j.signals.length})`;
    } else {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No signals found</td></tr>';
      document.getElementById('signals-summary').textContent = 'No signals found';
    }
  } catch (error) {
    console.error('Error loading signals:', error);
    document.getElementById('signals-summary').textContent = 'Error loading signals';
  }
}

function getStatusBadge(status) {
  const badges = {
    'PENDING': '<span class="badge bg-warning">PENDING</span>',
    'VALIDATED': '<span class="badge bg-success">VALIDATED</span>',
    'EXECUTED': '<span class="badge bg-primary">EXECUTED</span>',
    'REJECTED': '<span class="badge bg-danger">REJECTED</span>',
    'FALSE': '<span class="badge bg-secondary">FALSE</span>'
  };
  return badges[status] || '<span class="badge bg-light">UNKNOWN</span>';
}

async function validateSignal(signalId, isValid) {
  try {
    const response = await fetch(`/api/trading/signals/${signalId}/validate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        is_valid: isValid,
        validated_by: 'dashboard_user',
        notes: isValid ? 'Validated from dashboard' : 'Rejected from dashboard'
      })
    });
    
    if (response.ok) {
      // Reload signals to show updated status
      loadSignals();
      alert(`Signal ${isValid ? 'validated' : 'rejected'} successfully`);
    } else {
      alert('Error updating signal');
    }
  } catch (error) {
    console.error('Error validating signal:', error);
    alert('Error validating signal');
  }
}

async function viewSignal(signalId) {
  try {
    const response = await fetch(`/api/trading/signals/${signalId}`);
    const signal = await response.json();
    
    alert(`Signal Details:\n\nID: ${signal.id}\nSymbol: ${signal.symbol}\nAction: ${signal.action}\nPrice: $${signal.price}\nStatus: ${signal.status || 'PENDING'}\nCreated: ${new Date(signal.created_at).toLocaleString()}`);
  } catch (error) {
    console.error('Error viewing signal:', error);
    alert('Error loading signal details');
  }
}

document.getElementById('btn-filter').addEventListener('click', ()=>{
  const date = document.getElementById('filter-date').value;
  const symbol = document.getElementById('filter-symbol').value;
  loadSignals(date, symbol);
});

// Load signals on page load
loadSignals();
</script>
{% endblock %}
